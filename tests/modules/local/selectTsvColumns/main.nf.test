nextflow_process {

    name "Test process SELECT_TSV_COLUMNS"
    script "modules/local/selectTsvColumns/main.nf"
    process "SELECT_TSV_COLUMNS"
    config "tests/configs/run.config"
    tag "module"
    tag "select_tsv_columns"

    test("Should fail given invalid mode"){
        tag "expect_failed"
        when {
            params {
                input_path = "${projectDir}/test-data/toy-data/empty_file.txt"
                fields = "x,y,z"
                mode = "invalid"
            }
            process {
                '''
                input[0] = Channel.of("test").combine(Channel.of(params.input_path))
                input[1] = params.fields
                input[2] = params.mode
                '''
            }
        }
        then {
            assert process.failed
            assert process.exitStatus == 1
            assert !process.errorReport.contains("ValueError: Field not found in header")
            assert process.errorReport.contains("error: argument --mode/-m: invalid choice: 'invalid'")
        }
    }

    test("Should successfully downsample columns when only some are selected (in 'keep' mode)"){
        tag "expect_success"
        when {
            params {
                input_path = "${projectDir}/test-data/toy-data/test_tab_sorted.tsv"
                fields = "x,z"
                mode = "keep"
            }
            process {
                '''
                input[0] = Channel.of("test").combine(Channel.of(params.input_path))
                input[1] = params.fields
                input[2] = params.mode
                '''
            }
        }
        then {
            // Should run without failures
            assert process.success
            // Output and input row counts should match
            def tab_in = path(process.out.input[0][1]).csv(sep: "\t")
            def tab_out = path(process.out.output[0][1]).csv(sep: "\t")
            assert tab_out.rowCount == tab_in.rowCount
            // Selected columns should be unmodified
            def fields = params.fields.split(",")
            for (f in fields) {
                assert tab_out.columns[f] == tab_in.columns[f]
            }
            // Only selected columns should be present in output
            assert tab_out.columnNames == fields
        }
    }

    test("Should successfully downsample columns when only some are selected (in 'drop' mode)"){
        tag "expect_success"
        when {
            params {
                input_path = "${projectDir}/test-data/toy-data/test_tab_sorted.tsv"
                fields = "x,z"
                mode = "drop"
            }
            process {
                '''
                input[0] = Channel.of("test").combine(Channel.of(params.input_path))
                input[1] = params.fields
                input[2] = params.mode
                '''
            }
        }
        then {
            // Should run without failures
            assert process.success
            // Output and input row counts should match
            def tab_in = path(process.out.input[0][1]).csv(sep: "\t")
            def tab_out = path(process.out.output[0][1]).csv(sep: "\t")
            assert tab_out.rowCount == tab_in.rowCount
            // Output should be missing specified columns, with others unchanged
            def fields = params.fields.split(",")
            for (c in tab_in.columnNames) {
                if (fields.contains(c)) {
                    assert !tab_out.columnNames.contains(c)
                } else {
                    assert tab_out.columns[c] == tab_in.columns[c]
                }
            }
        }
    }
}

