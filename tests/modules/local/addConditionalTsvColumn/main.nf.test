nextflow_process {
    name "Test Process ADD_CONDITIONAL_TSV_COLUMN"
    script "modules/local/addConditionalTsvColumn/main.nf"
    process "ADD_CONDITIONAL_TSV_COLUMN"
    config "tests/configs/run.config"
    tag "process"
    tag "add_conditional_tsv_column"

    test("Should add conditional column based on column values") {
        tag "expect_success"
        when {
            params {
                column_params = [
                    chk_col: "x",
                    match_val: "0",
                    if_col: "y",
                    else_col: "z",
                    new_hdr: "selected"
                ]
            }
            process {
                """
                input[0] = ["sample1", file("${projectDir}/test-data/toy-data/test_tab_single.tsv")]
                input[1] = params.column_params
                """
            }
        }
        then {
            assert process.success // Basic success check
            def inputData = path("${projectDir}/test-data/toy-data/test_tab_single.tsv").csv(sep: "\t", decompress: false)
            def outputData = path(process.out.tsv[0][1]).csv(sep: "\t", decompress: false)
            assert outputData.rowCount == inputData.rowCount
            assert outputData.columnCount == inputData.columnCount + 1
            assert params.column_params.new_hdr in outputData.columns.keySet()
            for (int i = 0; i < outputData.rowCount; i++) {
                def xValue = outputData.columns[params.column_params.chk_col][i]
                def yValue = outputData.columns[params.column_params.if_col][i]
                def zValue = outputData.columns[params.column_params.else_col][i]
                def selectedValue = outputData.columns[params.column_params.new_hdr][i]
                if (xValue == 0) {
                    assert selectedValue == yValue
                } else {
                    assert selectedValue == zValue
                }
            }
        }
    }
}
