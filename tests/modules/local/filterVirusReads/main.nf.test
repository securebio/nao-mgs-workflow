// Helper function: manual table filtering
def filter_tab = { tab_in, threshold -> csv(tab_in.table.where(
    tab_in.table.intColumn("kraken2_assigned_host_virus").isEqualTo(1).or(
        tab_in.table.numberColumn("aligner_length_normalized_score").isGreaterThanOrEqualTo(threshold).and(
            tab_in.table.intColumn("kraken2_assigned_host_virus").isEqualTo(2).or(
                tab_in.table.booleanColumn("kraken2_classified").isFalse()))))) }

nextflow_process {

    name "Test process FILTER_VIRUS_READS"
    script "modules/local/filterVirusReads/main.nf"
    process "FILTER_VIRUS_READS"
    config "tests/configs/run.config"
    tag "module"
    tag "filter_virus_reads"

    test("Should run without failures on correct input and produce correct output (threshold = 15)"){
        tag "expect_success"
        when {
            params {}
            process {
                '''
                input[0] = "${projectDir}/test-data/toy-data/virus-hits-test.tsv"
                input[1] = 15
                input[2] = "test"
                '''
            }
        }
        then {
            // Should run without failures
            assert process.success
            // Generate expected output from input
            def tab_in = path(process.out.input[0]).csv(sep: "\t")
            def tab_out = path(process.out.output[0]).csv(sep: "\t", decompress: true)
            def tab_exp = filter_tab(tab_in, 15)
            assert tab_out.columnCount == tab_exp.ColumnCount
            assert tab_out.rowCount == tab_exp.rowCount
            assertTableEquals tab_exp, tab_out
            // Verify output manually
            assert tab_out.rowCount == 10
        }
    }

}
