def filter_tab = { tab_in, column, value -> csv(tab_in.table.where(tab_in.table.intColumn(column).isEqualTo(value))) }

nextflow_process {

    name "Test process PARTITION_TSV"
    script "modules/local/partitionTsv/main.nf"
    process "PARTITION_TSV"
    config "tests/configs/run.config"
    tag "module"
    tag "partition_tsv"

    test("Should correctly partition multi-value file") {
        tag "expect_success"
        when {
            params {
                column = "x"
            }
            process {
                '''
                input[0] = Channel.of("test")
                    | combine(Channel.of("${projectDir}/test-data/toy-data/test_tab_sorted.tsv"))
                input[1] = params.column
                '''
            }
        }
        then {
            // Should run without errors
            assert process.success
            // Should produce expected number of output tables
            def tab_in = path(process.out.input[0][1]).csv(sep: "\t")
            def tabs_out = process.out.output[0][1].collect{path(it).csv(sep: "\t")}
            def part_set = tab_in.columns[params.column] as Set
            def n_levels = part_set.size()
            assert tabs_out.size() == n_levels
            // Each partition should have expected content
            for (t in tabs_out) {
                def index = t.columns[params.column][0]
                def tab_in_filtered = filter_tab(tab_in, params.column, index)
                assertTableEquals t, tab_in_filtered
            }
        }
    }

}

