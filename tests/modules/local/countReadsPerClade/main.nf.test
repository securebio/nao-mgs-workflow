nextflow_process {

    name "Test process COUNT_READS_PER_CLADE"
    script "modules/local/countReadsPerClade/main.nf"
    process "COUNT_READS_PER_CLADE"
    config "tests/configs/run.config"
    tag "module"
    tag "count_reads_per_clade"

    test("Should produce correct output for toy data") {
        tag "expect_success"
        tag "validate_output"
        when {
            params {}
            process {
                '''
                input[0] = Channel.of("test")
                    | combine(Channel.of("${projectDir}/test-data/toy-data/count-reads-per-clade/test-reads.tsv"))
                input[1] = "${projectDir}/test-data/toy-data/count-reads-per-clade/test-taxonomy.tsv"
                '''
            }
        }
        then {
            // Should run without failures
            assert process.success

            // Output and input files should exist
            assert path(process.out.output[0][1]).exists()
            assert path(process.out.input[0][1]).exists()

            // Parse the gzipped output TSV and expected output TSV
            def output_tsv = path(process.out.output[0][1]).csv(sep: "\t", decompress: true)
            def expected_tsv = path("${projectDir}/test-data/toy-data/count-reads-per-clade/expected-output.tsv").csv(sep: "\t")

            // Should have same number of rows as expected
            assert output_tsv.rowCount == expected_tsv.rowCount

            // Check header columns match
            assert output_tsv.columnNames == expected_tsv.columnNames

            // Convert both to maps for easier comparison
            def output_rows_by_taxid = [:]
            output_tsv.rows.each { row ->
                output_rows_by_taxid[row.taxid] = row
            }

            def expected_rows_by_taxid = [:]
            expected_tsv.rows.each { row ->
                expected_rows_by_taxid[row.taxid] = row
            }

            // Compare each row
            expected_rows_by_taxid.each { taxid, expected_row ->
                def output_row = output_rows_by_taxid[taxid]
                assert output_row != null, "Missing taxid ${taxid} in output"
                assert output_row.group == expected_row.group
                assert output_row.parent_taxid == expected_row.parent_taxid
                assert output_row.reads_direct_total == expected_row.reads_direct_total
                assert output_row.reads_direct_dedup == expected_row.reads_direct_dedup
                assert output_row.reads_clade_total == expected_row.reads_clade_total
                assert output_row.reads_clade_dedup == expected_row.reads_clade_dedup
            }
        }
    }

}

