name: Benchmark test (Illumina 100M)

# This is a "release test" - see docs/ci.md for explanation of trigger strategy.
# Uses workflow_run to sequence after rust-tools.yml, ensuring ECR has the latest container.
on:
  pull_request:
    branches: [main, stable, ci-test]
  workflow_run:
    workflows: ["Rust Tools CI"]
    types: [completed]
    branches: [dev]

concurrency:
  group: benchmark-illumina-100M-${{ github.event.pull_request.number || github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: true

jobs:
  benchmark-illumina-100M:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    # For workflow_run events, only run if rust-tools succeeded
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.NAO_TESTING_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.NAO_TESTING_SECRET_ACCESS_KEY }}
      TOWER_ACCESS_TOKEN: ${{ secrets.TOWER_ACCESS_TOKEN }}
    steps:
      # workflow_run events run in default branch context, so we must explicitly
      # checkout the commit that triggered rust-tools.yml. See docs/ci.md.
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Check for relevant changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            relevant:
              - 'tests/modules/**'
              - 'modules/**'
              - 'tests/subworkflows/**'
              - 'subworkflows/**'
              - 'tests/workflows/**'
              - 'workflows/**'
              - 'bin/chain_workflows.py'
              - 'configs/**'
              - 'tests/configs/**'
              - '.github/workflows/benchmark-illumina-100M.yml'
              - '.github/actions/setup-nf-test/**'

      - name: Setup nf-test environment
        if: steps.filter.outputs.relevant == 'true'
        uses: ./.github/actions/setup-nf-test
        with:
          aws_access_key_id: ${{ secrets.NAO_TESTING_ACCESS_KEY }}
          aws_secret_access_key: ${{ secrets.NAO_TESTING_SECRET_ACCESS_KEY }}

      - name: Install Python dependencies
        if: steps.filter.outputs.relevant == 'true'
        run: pip install boto3

      - name: Run benchmark workflow
        if: steps.filter.outputs.relevant == 'true'
        run: |
          # Use ECR container - see docs/ci.md for Rust container strategy.
          # PRs to stable use :main; all other cases use :dev.
          RUST_VERSION="${{ github.base_ref == 'stable' && 'main' || 'dev' }}"
          bin/chain_workflows.py \
            --ref-dir s3://nao-testing/mgs-workflow-test/index-latest/output/ \
            --samplesheet s3://nao-testing/benchmarks/Illumina_100M/samplesheet.csv \
            --launch-dir test_run_benchmark_100M \
            --base-dir s3://nao-testing-scratch/mgs-workflow-test/benchmark-illumina-100M/ \
            --rust_tools_version "$RUST_VERSION"
