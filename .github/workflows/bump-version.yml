name: Bump Version

on:
  push:
    branches:
      - main

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      is_bot: ${{ steps.release-bot.outputs.is_bot }}
    steps:
      - uses: actions/checkout@v4
      - name: Check release bot actor
        id: release-bot
        uses: ./.github/actions/check-release-bot
        with:
          app-id: ${{ vars.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

  bump-version:
    needs: check
    if: needs.check.outputs.is_bot != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Generate token from GitHub App
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install bump-my-version
        run: pip install bump-my-version

      - name: Extract bump type from CHANGELOG
        id: bump_type
        run: |
          # Validate CHANGELOG starts with "# Unreleased" followed by valid bump_type on line 2
          if ! head -n 2 CHANGELOG.md | grep -Pzo "^# Unreleased\nbump_type: (major|schema|results|point)" > /dev/null; then
            echo "ERROR: CHANGELOG.md must start with '# Unreleased' followed by valid 'bump_type:'"
            echo "Valid bump_type values: major, schema, results, point"
            exit 1
          fi
          bump_type=$(sed -n '2s/^bump_type: *//p' CHANGELOG.md)
          echo "type=$bump_type" >> $GITHUB_OUTPUT
          echo "Found bump_type: $bump_type"

      - name: Bump version
        run: |
          bump-my-version bump ${{ steps.bump_type.outputs.type }}
          echo "New version: $(bump-my-version show current_version)"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push
        run: |
          version=$(bump-my-version show current_version)
          git add pyproject.toml CHANGELOG.md
          git commit -m "Bump version to $version"
          git push
