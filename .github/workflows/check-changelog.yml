name: CHANGELOG.md update check

on:
  pull_request:
    branches:
      - dev
      - ci-test

jobs:
  changelog:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for non-documentation changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            non_docs:
              - '**'
              - '!**/*.md'
              - '!docs/**'

      - name: Check for CHANGELOG update
        uses: dorny/paths-filter@v3
        id: changelog
        with:
          filters: |
            updated:
              - 'CHANGELOG.md'

      - name: Require CHANGELOG update
        if: steps.filter.outputs.non_docs == 'true' && steps.changelog.outputs.updated != 'true'
        run: |
          echo "::error::This PR modifies non-documentation files but does not update CHANGELOG.md"
          echo ""
          echo "Please add an entry to CHANGELOG.md describing your changes."
          exit 1

      - name: Check for Unreleased section with bump_type
        run: |
          if ! head -n 2 CHANGELOG.md | grep -Pzo "^# Unreleased\nbump_type: (major|schema|results|point)" > /dev/null; then
            echo "::error::CHANGELOG.md must start with '# Unreleased' followed by valid 'bump_type:'"
            echo ""
            echo "The first two lines of CHANGELOG.md should be:"
            echo "  # Unreleased"
            echo "  bump_type: <type>"
            echo ""
            echo "Valid bump_type values:"
            echo "  major   - Breaking changes (X.0.0.0)"
            echo "  schema  - Schema changes (X.Y.0.0)"
            echo "  results - Results changes (X.Y.Z.0)"
            echo "  point   - Minor changes (X.Y.Z.W)"
            exit 1
          fi
