name: CHANGELOG.md update check

on:
  pull_request:
    branches:
      - dev
      - ci-test

jobs:
  changelog:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for non-documentation changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            non_docs:
              - '**'
              - '!**/*.md'
              - '!docs/**'

      - name: Check for CHANGELOG update
        uses: dorny/paths-filter@v3
        id: changelog
        with:
          filters: |
            updated:
              - 'CHANGELOG.md'

      - name: Require CHANGELOG update
        if: steps.filter.outputs.non_docs == 'true' && steps.changelog.outputs.updated != 'true'
        run: |
          echo "::error::This PR modifies non-documentation files but does not update CHANGELOG.md"
          echo ""
          echo "Please add an entry to CHANGELOG.md describing your changes."
          exit 1

      - name: Check for content in current version section
        run: |
          # Extract lines from line 2 until next version header, excluding blank lines and sub-headers
          content=$(awk 'NR>=2 && /^# v/{exit} NR>=2' CHANGELOG.md | grep -v '^[[:space:]]*$' | grep -v '^##' || true)
          if [ -z "$content" ]; then
            echo "::error::CHANGELOG.md version section has no content"
            echo ""
            echo "Add changelog entries describing your changes before merging."
            exit 1
          fi
