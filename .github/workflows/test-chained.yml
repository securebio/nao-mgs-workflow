name: Nextflow integration test (chain workflows)

# This is a "release test" - see docs/ci.md for explanation of trigger strategy.
# Uses workflow_run to sequence after rust-tools.yml, ensuring ECR has the latest container.
on:
  pull_request:
    branches: [main, stable, ci-test]
  workflow_run:
    workflows: ["Rust Tools CI"]
    types: [completed]
    branches: [dev]

concurrency:
  group: ci-integration-test-${{ github.event.pull_request.number || github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: true

jobs:
  integration-test-chained:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    # For workflow_run events, only run if rust-tools succeeded
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.NAO_TESTING_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.NAO_TESTING_SECRET_ACCESS_KEY }}
      TOWER_ACCESS_TOKEN: ${{ secrets.TOWER_ACCESS_TOKEN }}
    steps:
      # workflow_run events run in default branch context, so we must explicitly
      # checkout the commit that triggered rust-tools.yml. See docs/ci.md.
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Check for relevant changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            chained:
              - 'tests/modules/**'
              - 'modules/**'
              - 'tests/subworkflows/**'
              - 'subworkflows/**'
              - 'tests/workflows/**'
              - 'workflows/**'
              - 'bin/chain_workflows.py'
              - 'configs/**'
              - 'tests/configs/**'
              - '.github/workflows/test-chained.yml'
              - '.github/actions/setup-nf-test/**'

      - name: Setup nf-test environment
        if: steps.filter.outputs.chained == 'true'
        uses: ./.github/actions/setup-nf-test
        with:
          aws_access_key_id: ${{ secrets.NAO_TESTING_ACCESS_KEY }}
          aws_secret_access_key: ${{ secrets.NAO_TESTING_SECRET_ACCESS_KEY }}

      - name: Install Python dependencies
        if: steps.filter.outputs.chained == 'true'
        run: pip install boto3

      - name: Run chain workflows integration test
        if: steps.filter.outputs.chained == 'true'
        run: |
          # Use ECR container (Wave/Fusion requirement - can't use local containers).
          # PRs to stable (from main) use :main; all other cases use :dev.
          # See docs/ci.md for full explanation of Rust container strategy.
          RUST_VERSION="${{ github.base_ref == 'stable' && 'main' || 'dev' }}"
          bin/chain_workflows.py --no-resume \
            --base-dir s3://nao-testing-scratch/mgs-workflow-test \
            --rust_tools_version "$RUST_VERSION"
