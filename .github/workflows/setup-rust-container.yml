# Reusable workflow: Determine and optionally build the Rust tools container
#
# This workflow checks if Rust source has changed relative to main/dev.
# If unchanged, tests can use the existing ECR container.
# If changed, it builds a local container for the calling workflow to use.
#
# Used by: nf-test-*.yml workflows (5 total). NOT used by release tests

name: Setup Rust Container

on:
  workflow_call:
    outputs:
      rust-changed:
        description: '"true" if Rust code changed and container was built, "false" otherwise. When true, use rust_dev profile.'
        value: ${{ jobs.setup.outputs.rust-changed }}
      container-args:
        description: 'Extra nextflow args for container version (e.g., "--rust_tools_version dev"). Empty when rust-changed=true or using main.'
        value: ${{ jobs.setup.outputs.container-args }}
      nextflow-args:
        description: 'Ready-to-use nextflow args: "--profile=rust_dev" when rust changed, or container-args otherwise. Use directly without conditional logic.'
        value: ${{ jobs.setup.outputs.nextflow-args }}

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      rust-changed: ${{ steps.check.outputs.rust-changed }}
      container-args: ${{ steps.check.outputs.container-args }}
      nextflow-args: ${{ steps.check.outputs.nextflow-args }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for git diff against main/dev

      - name: Check for Rust changes vs main/dev
        id: check
        run: |
          RUST_PATHS="rust-tools/ docker/nao-rust-tools.Dockerfile"

          # Check if Rust files are identical to main
          if git diff --quiet origin/main -- $RUST_PATHS 2>/dev/null; then
            echo "Rust code matches main, using ECR :main"
            echo "rust-changed=false" >> $GITHUB_OUTPUT
            echo "container-args=" >> $GITHUB_OUTPUT
            echo "nextflow-args=" >> $GITHUB_OUTPUT

          # Check if Rust files are identical to dev
          elif git diff --quiet origin/dev -- $RUST_PATHS 2>/dev/null; then
            echo "Rust code matches dev, using ECR :dev"
            echo "rust-changed=false" >> $GITHUB_OUTPUT
            echo "container-args=--rust_tools_version dev" >> $GITHUB_OUTPUT
            echo "nextflow-args=--rust_tools_version dev" >> $GITHUB_OUTPUT

          # Rust code has changed - need to build local container
          else
            echo "Rust code has changed, will build local container"
            echo "rust-changed=true" >> $GITHUB_OUTPUT
            echo "container-args=" >> $GITHUB_OUTPUT
            echo "nextflow-args=--profile=rust_dev" >> $GITHUB_OUTPUT
          fi

      # Compute hash of Rust source for cache key
      - name: Compute Rust source hash
        if: steps.check.outputs.rust-changed == 'true'
        id: hash
        run: |
          HASH=$(find rust-tools/ -type f | sort | xargs cat | cat - docker/nao-rust-tools.Dockerfile | sha256sum | cut -d' ' -f1)
          echo "hash=${HASH:0:16}" >> $GITHUB_OUTPUT
          echo "Rust source hash: ${HASH:0:16}"

      # Try to restore container from cache (shared across all workflows)
      - name: Restore Rust container from cache
        if: steps.check.outputs.rust-changed == 'true'
        id: cache
        uses: actions/cache@v4
        with:
          path: rust-tools.tar.gz
          key: rust-container-${{ steps.hash.outputs.hash }}

      # Build only if cache miss
      - name: Build Rust container
        if: steps.check.outputs.rust-changed == 'true' && steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "Cache miss - building Rust tools container..."
          docker build --progress=plain -f docker/nao-rust-tools.Dockerfile -t nao-rust-tools:local .
          docker save nao-rust-tools:local | gzip > rust-tools.tar.gz

      - name: Report cache hit
        if: steps.check.outputs.rust-changed == 'true' && steps.cache.outputs.cache-hit == 'true'
        run: echo "Cache hit - using cached container"

      # Upload as artifact for the calling workflow to download
      # (artifacts are workflow-scoped, cache is repo-scoped)
      - name: Upload container artifact
        if: steps.check.outputs.rust-changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: rust-container
          path: rust-tools.tar.gz
          retention-days: 1
