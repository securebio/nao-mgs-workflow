name: Check version bump

on:
  pull_request:
    branches: [main, dev, stable, ci-test]

jobs:
  check-version-bump:
    runs-on: ubuntu-latest
    # Skip release commits and PRs from dev to main (already validated on dev)
    if: "!contains(github.event.pull_request.title, '[release]') && github.head_ref != 'dev'"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install bump-my-version
        run: pip install bump-my-version

      - name: Validate CHANGELOG format
        run: |
          # Validate CHANGELOG starts with "# Unreleased" followed by valid bump_type on line 2
          if ! head -n 2 CHANGELOG.md | grep -Pzo "^# Unreleased\nbump_type: (major|schema|results|point)" > /dev/null; then
            echo "::error::CHANGELOG.md must start with '# Unreleased' followed by valid 'bump_type:'"
            echo ""
            echo "Valid bump_type values: major, schema, results, point"
            exit 1
          fi

      - name: Extract bump type and dry-run bump-my-version
        run: |
          bump_type=$(sed -n '2s/^bump_type: *//p' CHANGELOG.md)
          echo "Found bump_type: $bump_type"
          echo "Running dry-run of version bump..."
          bump-my-version bump $bump_type --dry-run --verbose
