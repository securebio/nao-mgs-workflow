// Enforce minimum Nextflow version required to run this pipeline
// The '!' prefix makes this a hard requirement (fails instead of warning)
manifest {
    nextflowVersion = '!>=25.10.2'
}

// Currently universal settings
docker.enabled = true
wave.enabled = true
aws.client.maxConnections = 1000
aws.client.maxErrorRetry = 10
aws.client.connectionTimeout = 0
aws.client.socketTimeout = 0
nextflow.enable.moduleBinaries = true

params {
    db_download_timeout = 1200 // Timeout in seconds for database downloads (default: 20 minutes)
}

// Workflow run profiles
profiles {
    standard { // Run on AWS Batch
        fusion.enabled = true
        fusion.exportStorageCredentials = true
        process.executor = "awsbatch"
        process.errorStrategy = "retry"
        process.maxRetries = 3
        aws.batch.volumes = ['/scratch:/scratch'] // Shared directory for large reference files
    }
    batch { // Run on AWS Batch
        fusion.enabled = true
        fusion.exportStorageCredentials = true
        process.executor = "awsbatch"
        process.errorStrategy = "retry"
        process.maxRetries = 3
        aws.batch.volumes = ['/scratch:/scratch'] // Shared directory for large reference files
    }
    ec2_local { // Run on EC2 instance with a local working directory
        wave.enabled = false
        fusion.enabled = false
        process.errorStrategy = "finish"
        docker.runOptions = '-v $HOME/.aws:/root/.aws -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY'
        // Mount AWS credentials to the container; required for S3 access
    }
    ec2_s3 { // Run on EC2 instance with an S3 working directory
        fusion.enabled = true
        fusion.exportStorageCredentials = true
        process.errorStrategy = "retry"
    }
    test_run { // Testing only
        fusion.enabled = true
        fusion.exportStorageCredentials = true
        process.executor = "awsbatch"
        aws.batch.volumes = ['/scratch:/scratch'] // Shared directory for large reference files
        process.queue = "workflow-test-batch-jq"
        process.errorStrategy = "retry"
        process.maxRetries = 1

    }
    rust_dev { // Use locally-built Rust tools container for development
        // Wave must be disabled because it can't access local Docker images.
        // The rust_dev profile uses a locally-built container (nao-rust-tools:local)
        // which only exists on the developer's machine, not in any registry.
        wave.enabled = false
        process {
            withLabel: 'rust_tools' {
                container = "nao-rust-tools:local"
            }
        }
    }
}

// Set working directory
workDir = "${params.base_dir}/work"
